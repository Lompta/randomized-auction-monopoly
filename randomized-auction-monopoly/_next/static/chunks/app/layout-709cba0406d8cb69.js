(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{447:function(e,t,n){Promise.resolve().then(n.t.bind(n,2778,23)),Promise.resolve().then(n.bind(n,8851))},8851:function(e,t,n){"use strict";n.d(t,{default:function(){return o}});var r=n(7437),s=n(1717);function o(e){let{children:t}=e;return(0,r.jsx)(s.E,{children:t})}},1717:function(e,t,n){"use strict";n.d(t,{E:function(){return c},r:function(){return l}});var r=n(7437),s=n(2265),o=n(4370);class i{setMyName(e){this.myName=e,this.isHost&&(this.connectedPlayers.add(e),this.broadcastPlayerList())}broadcastPlayerList(){this.isHost&&(console.log("Broadcasting player list:",Array.from(this.connectedPlayers)),this.broadcast({type:"PLAYER_LIST",players:Array.from(this.connectedPlayers)}))}async hostGame(){return new Promise((e,t)=>{if(this.isHost=!0,this.myName&&this.connectedPlayers.add(this.myName),this.peer.id)e(this.peer.id);else{let n=setTimeout(()=>{t(Error("Timeout waiting for peer ID"))},1e4);this.peer.on("open",t=>{clearTimeout(n),e(t)})}})}async joinGame(e){return new Promise((t,n)=>{let r=this.peer.connect(e,{reliable:!0}),s=setTimeout(()=>{r.close(),n(Error("Connection timeout"))},1e4);r.on("open",()=>{clearTimeout(s),this.setupConnection(r),this.myName&&r.send({type:"PLAYER_JOIN",name:this.myName}),t()}),r.on("error",e=>{clearTimeout(s),n(e)})})}setupConnection(e){this.connections.set(e.peer,e),e.on("data",e=>{this.isValidGameMessage(e)&&(console.log("Received message:",e),"PLAYER_JOIN"===e.type?this.isHost&&!this.connectedPlayers.has(e.name)&&(this.connectedPlayers.add(e.name),this.broadcastPlayerList()):"PLAYER_LIST"!==e.type||this.isHost||(this.connectedPlayers=new Set(e.players)),this.messageHandlers.forEach(t=>t(e)))}),e.on("close",()=>{console.log("Connection closed:",e.peer),this.connections.delete(e.peer)})}getConnectedPlayers(){return Array.from(this.connectedPlayers)}onMessage(e){return this.messageHandlers.push(e),()=>{this.messageHandlers=this.messageHandlers.filter(t=>t!==e)}}broadcast(e){console.log("Broadcasting message:",e),this.connections.forEach(t=>{try{t.send(e)}catch(e){console.error("Failed to send message to peer:",e)}}),this.isHost&&this.messageHandlers.forEach(t=>t(e))}close(){this.connections.forEach(e=>e.close()),this.connections.clear(),this.connectedPlayers.clear(),this.messageHandlers=[],this.peer.destroy()}isValidGameMessage(e){if(!e||"object"!=typeof e||!("type"in e))return!1;switch(e.type){case"GAME_START":return!0;case"GAME_STATE":return"state"in e;case"PLAYER_JOIN":return"string"==typeof e.name;case"PLAYER_LIST":return Array.isArray(e.players);case"BID":return"number"==typeof e.amount&&"string"==typeof e.player;case"PASS":return"string"==typeof e.player;case"SIMULATION_RESULTS":return"results"in e;default:return!1}}constructor(){this.connections=new Map,this.isHost=!1,this.messageHandlers=[],this.connectedPlayers=new Set,this.myName="";let e=Math.random().toString(36).substr(2,9);this.peer=new o.ZP(e),this.peer.on("error",e=>{console.error("Peer error:",e)}),this.peer.on("disconnected",()=>{console.log("Peer disconnected. Attempting to reconnect..."),this.peer.reconnect()}),this.peer.on("connection",e=>{console.log("Received connection from peer:",e.peer),this.setupConnection(e)})}}let a=(0,s.createContext)(null);function c(e){let{children:t}=e,n=(0,s.useRef)(null),[o,c]=(0,s.useState)(!1),[l,u]=(0,s.useState)([]),[h,d]=(0,s.useState)(!1);(0,s.useEffect)(()=>{n.current||(console.log("Creating new PeerManager"),n.current=new i);let e=n.current;return()=>{document.body.contains(document.getElementById("__next"))||(console.log("Truly unmounting, closing peer manager"),e.close(),n.current=null)}},[]),(0,s.useEffect)(()=>{let e=n.current;if(!e)return;let t=e.onMessage(e=>{console.log("PeerContext received message:",e),"PLAYER_LIST"===e.type?u(e.players):"PLAYER_JOIN"===e.type?u(t=>t.includes(e.name)?t:[...t,e.name]):"GAME_START"===e.type&&d(!0)});return()=>t()},[]);let m=(0,s.useCallback)(e=>{n.current&&(n.current.setMyName(e),l.includes(e)||u(t=>[...t,e]))},[l]),y=(0,s.useCallback)(async()=>{if(!n.current)throw Error("PeerManager not initialized");let e=await n.current.hostGame();return c(!0),e},[]),p=(0,s.useCallback)(async e=>{if(!n.current)throw Error("PeerManager not initialized");await n.current.joinGame(e),c(!1)},[]);return(0,r.jsx)(a.Provider,{value:{peerManager:n.current,isHost:o,connectedPlayers:l,setPlayerName:m,hostGame:y,joinGame:p,gameStarted:h,setGameStarted:d},children:t})}let l=()=>{let e=(0,s.useContext)(a);if(!e)throw Error("usePeer must be used within a PeerProvider");return e}},2778:function(){}},function(e){e.O(0,[461,370,971,117,744],function(){return e(e.s=447)}),_N_E=e.O()}]);